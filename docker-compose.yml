version: '2'
services:
  zookeeper:
    image: wurstmeister/zookeeper
    ports:
      - "2181:2181"
  kafka:
    build: .
    ports:
      - "9092"
      - "7777:7777" # Kafka Jolokia
      - "6777:6777" # Consumer Jolokia
      - "5777:5777" # Producer Jolokia
    environment:
      # modify the KAFKA_ADVERTISED_HOST_NAME in docker-compose.yml to match your docker host IP
      # (Note: Do not use localhost or 127.0.0.1 as the host ip if you want to run multiple brokers.)
      KAFKA_ADVERTISED_HOST_NAME: 10.100.0.103
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_JOLOKIA_PORT: 7777
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - $PWD:$PWD
    working_dir: $PWD
  influxdb_v2:
    image: quay.io/influxdb/influxdb:2.0.0-beta
    volumes:
      - $PWD:$PWD
    working_dir: $PWD
    ports:
      - "9999:9999"
  telegraf:
    image: telegraf:latest
    restart: always
    environment:
      INFLUX_HOST: http://influxdb_v2:9999/
      INFLUX_TOKEN: my-token
      INFLUX_ORG: my-org
      INFLUX_BUCKET: my-bucket
      KAFKA_JOLOKIA_HOSTS: http://kafka:7777/jolokia
      KAFKA_PRODUCERS_JOLOKIA_HOSTS: http://kafka:5777/jolokia
      KAFKA_CONSUMERS_JOLOKIA_HOSTS: http://kafka:6777/jolokia
      ZOOKEEPER_HOST: zookeeper:2181
    depends_on:
      - influxdb_v2
    volumes:
      - $PWD/kafka-zk-jolokia.conf:/etc/telegraf/telegraf.conf:ro
  dependencies-all:
    image: ubuntu:18.04
    command: sleep infinity
    depends_on:
      - zookeeper
      - kafka
      - influxdb_v2
